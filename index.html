<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>100-дневный челлендж — прогресс</title>
  <style>
    :root{
      --bg:#0b0d10; --card:#111418; --fg:#e7e9ee; --muted:#9aa3af; --accent:#7dd3fc;
      --ok:#34d399; --warn:#f59e0b; --bad:#ef4444; --grid:#1a1f24; --cell:#222831; --cell-filled:#60a5fa;
      --radius:16px;
    }
    
    /* Светлая тема */
    [data-theme="light"] {
      --bg: #fefefe;
      --card: #ffffff;
      --fg: #1e293b;
      --muted: #64748b;
      --accent: #dc2626;
      --ok: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --grid: #f1f5f9;
      --cell: #f8fafc;
      --cell-filled: #dc2626;
    }
    
    /* Плавные переходы между темами */
    * {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:transparent;color:var(--fg);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;position:relative;overflow-x:hidden}
    
    /* Анимированный фон */
    .bg-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -2;
      background: linear-gradient(45deg, #0b0d10, #111827, #0b0d10, #1e293b, #0b0d10);
      background-size: 400% 400%;
      animation: gradientShift 15s ease infinite;
    }
    
    [data-theme="light"] .bg-animation {
      background: linear-gradient(45deg, #fefefe, #f8fafc, #fefefe, #f1f5f9, #fefefe);
    }
    
    /* Переливающаяся сетка на фоне */
    .bg-grid {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background-image: 
        linear-gradient(rgba(59, 130, 246, 0.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(59, 130, 246, 0.08) 1px, transparent 1px);
      background-size: 40px 40px;
      animation: gridMove 12s linear infinite;
    }
    
    [data-theme="light"] .bg-grid {
      background-image: 
        linear-gradient(rgba(220, 38, 38, 0.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(220, 38, 38, 0.08) 1px, transparent 1px);
    }
    
    @keyframes gridMove {
      0% { transform: translate(0, 0); }
      100% { transform: translate(40px, 40px); }
    }
    
    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .bg-particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
    }
    
    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: rgba(125, 211, 252, 0.3);
      border-radius: 50%;
      animation: float 20s infinite linear;
    }
    
    [data-theme="light"] .particle {
      background: rgba(220, 38, 38, 0.15);
    }
    
    @keyframes float {
      0% {
        transform: translateY(100vh) translateX(0);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-100px) translateX(100px);
        opacity: 0;
      }
    }
    .wrap{max-width:1080px;margin:0 auto;padding:20px}
    header{text-align:center;margin-bottom:8px;position:relative}
    .title{font-size:48px;font-weight:700;letter-spacing:-0.5px;margin-bottom:12px;background:linear-gradient(135deg, #ffffff, #a855f7, #3b82f6, #06b6d4);background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-size:200% 200%;animation:titleGradient 3s ease infinite}
    
    [data-theme="light"] .title {
      background: linear-gradient(135deg, #dc2626, #ea580c, #f59e0b, #dc2626);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .sub{color:var(--muted);font-size:18px;font-weight:400}
    
    /* Переключатель темы */
    .theme-toggle {
      position: absolute;
      top: 0;
      right: 0;
      background: var(--card);
      border: 1px solid var(--grid);
      border-radius: 50px;
      padding: 8px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--fg);
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .theme-toggle:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .theme-icon {
      font-size: 16px;
      transition: transform 0.3s ease;
    }
    
    .theme-toggle:hover .theme-icon {
      transform: rotate(15deg);
    }
    
    @keyframes titleGradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:#0f141a;border:1px solid #1f242b;font-size:12px}
    .card{background:transparent;border:none;border-radius:var(--radius);padding:16px}


    /* Сетка 1000 клеток */
    .grid{display:grid;gap:3px;grid-template-columns:repeat(40, minmax(0,1fr));
      background:transparent;padding:20px;position:relative}
    .cell{
      aspect-ratio:1/1;border-radius:0px;background:#1a1a1a;border:none;
      position:relative;overflow:hidden;transition: box-shadow 0.2s ease, background-color 0.2s ease;cursor:pointer;
      box-shadow:0 1px 3px rgba(0,0,0,0.3)
    }
    
    [data-theme="light"] .cell {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .cell:hover{box-shadow:0 2px 12px rgba(0,0,0,0.5), 0 0 0 1px rgba(125,211,252,0.3), 0 6px 18px rgba(125,211,252,0.18)}
    .cell:not(.filled):hover{background-color:#1e2530}
    
    [data-theme="light"] .cell:hover {
      box-shadow: 0 2px 12px rgba(0,0,0,0.15), 0 0 0 1px rgba(220, 38, 38, 0.3), 0 6px 18px rgba(220, 38, 38, 0.18);
    }
    
    [data-theme="light"] .cell:not(.filled):hover {
      background-color: #f1f5f9;
      border-color: #cbd5e1;
    }
    
    .cell.filled{
      background: linear-gradient(135deg, #8b5cf6, #3b82f6, #06b6d4, #10b981);
      background-size: 200% 200%;
      animation: cellGradient 4s ease infinite;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    
    [data-theme="light"] .cell.filled {
      background: linear-gradient(135deg, #dc2626, #ea580c, #d97706, #dc2626);
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    
    @keyframes cellGradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    
    /* частично заполненная (если решишь учитывать дробные часы) */
    .cell.partial::after{
      content:""; position:absolute; left:0; top:0; bottom:0; width:var(--part,0%);
      background:linear-gradient(90deg, rgba(255,255,255,.12), rgba(255,255,255,.12));
    }
    
    [data-theme="light"] .cell.partial::after {
      background: linear-gradient(90deg, rgba(255,255,255,.2), rgba(255,255,255,.2));
    }

    .footer{margin-top:12px;font-size:12px;color:var(--muted);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}

    /* Информационные блоки в стиле Florin Pop */
    .info-blocks {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-top: 40px;
      padding: 0 36px;
      max-width: 1080px;
      margin-left: auto;
      margin-right: auto;
    }

    .info-block {
      background: linear-gradient(135deg, #0f141a 0%, #1a1f24 100%);
      border: 1px solid #1f242b;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    [data-theme="light"] .info-block {
      background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%);
      border: 1px solid #e2e8f0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    

    .info-block::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #8b5cf6, #3b82f6, #06b6d4, #10b981);
      background-size: 200% 100%;
      animation: gradientShift 3s ease infinite;
    }
    
    [data-theme="light"] .info-block::before {
      background: linear-gradient(90deg, #dc2626, #ea580c, #f59e0b, #dc2626);
    }

    .info-block:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
      border-color: #3b82f6;
    }
    
    [data-theme="light"] .info-block:hover {
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
      border-color: #dc2626;
    }

    .info-title {
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-title .small-text {
      font-size: 10px;
      text-transform: none;
      font-weight: 400;
      letter-spacing: 0.2px;
    }

    .info-title::before {
      content: '';
      width: 4px;
      height: 4px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 2s ease infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .info-value {
      color: var(--fg);
      font-size: 28px;
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #ffffff, #a855f7, #3b82f6);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 200% 200%;
      animation: titleGradient 3s ease infinite;
    }
    
    [data-theme="light"] .info-value {
      background: linear-gradient(135deg, #dc2626, #ea580c, #f59e0b);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .info-subtitle {
      color: var(--muted);
      font-size: 12px;
      font-weight: 400;
      margin-top: 4px;
    }

    /* Прогресс-бар для Total Hours */
    .info-progress {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .info-progress-bar {
      flex: 1;
      height: 8px;
      background: #1f242b;
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    
    [data-theme="light"] .info-progress-bar {
      background: #e2e8f0;
    }

    .info-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #8b5cf6, #3b82f6, #06b6d4, #10b981);
      background-size: 200% 100%;
      animation: gradientShift 3s ease infinite;
      border-radius: 4px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    
    [data-theme="light"] .info-progress-fill {
      background: linear-gradient(90deg, #dc2626, #ea580c, #f59e0b, #dc2626);
    }

    .info-progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      animation: shimmer 2s ease infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .info-percentage {
      color: var(--accent);
      font-size: 18px;
      font-weight: 700;
      min-width: 50px;
      text-align: right;
    }

    /* Выпадающие списки */
    .dropdowns-section {
      max-width: 1080px;
      margin: 40px auto 0;
      padding: 0 20px;
    }

    .dropdown {
      margin-bottom: 16px;
      background: var(--card);
      border: 1px solid var(--grid);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .dropdown:hover {
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .dropdown-toggle {
      width: 100%;
      background: transparent;
      border: none;
      padding: 20px 24px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      text-align: left;
      color: var(--fg);
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .dropdown-toggle:hover {
      background: rgba(0, 0, 0, 0.02);
    }

    [data-theme="light"] .dropdown-toggle:hover {
      background: rgba(0, 0, 0, 0.03);
    }

    .dropdown-title {
      flex: 1;
      margin-right: 16px;
    }

    .dropdown-icon {
      font-size: 14px;
      transition: transform 0.3s ease;
      color: var(--accent);
    }

    .dropdown.active .dropdown-icon {
      transform: rotate(180deg);
    }

    .dropdown-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: rgba(0, 0, 0, 0.02);
    }

    [data-theme="light"] .dropdown-content {
      background: rgba(0, 0, 0, 0.01);
    }

    .dropdown.active .dropdown-content {
      max-height: 500px;
    }

    .dropdown-content ul {
      margin: 0;
      padding: 0 24px 20px;
      list-style: none;
    }

    .dropdown-content li {
      padding: 8px 0;
      color: var(--muted);
      line-height: 1.6;
    }

    .dropdown-content p {
      margin: 0;
      padding: 20px 24px;
      color: var(--muted);
      line-height: 1.6;
    }

    .dropdown-content a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
    }

    .dropdown-content a:hover {
      text-decoration: underline;
    }

    .dropdown-content strong {
      color: var(--fg);
      font-weight: 600;
    }



    /* Адаптивность */
    @media (max-width: 768px) {
      .wrap {
        padding: 12px;
      }

      header { margin-bottom: 4px; }
      .title { font-size: 32px; line-height: 1.1; }
      .sub { font-size: 14px; }
      
      .theme-toggle {
        position: static;
        margin: 0 auto 16px auto;
        width: fit-content;
        font-size: 12px;
        padding: 6px 12px;
      }

      .grid {
        grid-template-columns: repeat(20, minmax(0, 1fr));
        gap: 4px;
        padding: 12px;
      }

      .cell {
        border-radius: 6px;
      }
      .info-blocks {
        grid-template-columns: 1fr;
        gap: 12px;
        margin-top: 20px;
        padding: 0 28px;
      }
      
      .info-block {
        margin: 0;
      }
      
      .info-block {
        padding: 16px;
        border-radius: 12px;
      }
      
      .info-value {
        font-size: 22px;
      }
      
      .info-title {
        font-size: 12px;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 6px;
      }
      
      .info-title .small-text {
        display: block;
        font-size: 10px;
        opacity: 0.85;
        margin-top: 2px;
      }

      .info-title, .info-value { 
        word-break: break-word; 
        overflow-wrap: anywhere; 
      }
      
      .info-progress {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }
      .info-progress-bar { height: 6px; }
      
      .info-percentage {
        text-align: center;
        font-size: 14px;
      }
      
      .dropdowns-section {
        padding: 0 12px;
        margin-top: 20px;
      }
      
      .dropdown-toggle {
        padding: 16px 20px;
        font-size: 14px;
      }
      
      .dropdown-content ul {
        padding: 0 20px 16px;
      }
      
      .dropdown-content li {
        padding: 6px 0;
        font-size: 14px;
      }
      
      .dropdown-content p {
        padding: 16px 20px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- Анимированный фон -->
  <div class="bg-animation"></div>
  <div class="bg-grid"></div>
  <div class="bg-particles" id="particles"></div>
  
  <div class="wrap">
    <header>
      <div class="theme-toggle" id="themeToggle">
        <span class="theme-icon" id="themeIcon">🌙</span>
        <span id="themeText">Темная</span>
      </div>
      <div class="title">1000 Hours Grid</div>
      <div class="sub">Для 100-дневного челленджа. Каждый квадрат представляет 1 час.</div>
    </header>

    <section class="card">
      <div id="grid" class="grid" aria-label="Grid of hours"></div>
      

      <div class="footer">
        <div id="percent" class="muted"></div>
      </div>
    </section>

    <!-- Дополнительные информационные блоки -->
    <section class="info-blocks">
      <div class="info-block">
        <div class="info-title">Total</div>
        <div class="info-value" id="totalHours">0 <span class="small-text">hours</span></div>
        <div class="info-progress">
          <div class="info-progress-bar">
            <div class="info-progress-fill" id="totalProgressFill"></div>
          </div>
          <div class="info-percentage" id="totalPercentage">0%</div>
        </div>
      </div>
      
      <div class="info-block">
        <div class="info-title">Time Remaining <span class="small-text">(until 01.01.2026)</span></div>
        <div class="info-value" id="timeRemaining">—</div>
        <div class="info-progress">
          <div class="info-progress-bar">
            <div class="info-progress-fill" id="timeProgressFill"></div>
          </div>
          <div class="info-percentage" id="timePercentage">0%</div>
        </div>
      </div>
      
      <div class="info-block">
        <div class="info-title">Last Updated</div>
        <div class="info-value" id="lastUpdated">—</div>
      </div>
    </section>

    <!-- Выпадающие списки с информацией -->
    <section class="dropdowns-section">
      <div class="dropdown">
        <button class="dropdown-toggle" data-target="spheres">
          <span class="dropdown-title">Какие сферы я отслеживаю</span>
          <span class="dropdown-icon">▼</span>
        </button>
        <div class="dropdown-content" id="spheres">
          <ul>
            <li><strong>AI&ML</strong> — курсы, проекты, книги по AI&ML</li>
            <li><strong>Lifestyle</strong> — всё остальное обучение, помимо AI&ML, например, подготовка к сдаче на права</li>
            <li><strong>Health</strong> — спорт, баня и тому подобное</li>
            <li><strong>Reflection</strong> — планирование, рефлексия</li>
            <li><strong>Work</strong> — основная работа</li>
          </ul>
        </div>
      </div>

      <div class="dropdown">
        <button class="dropdown-toggle" data-target="tracking">
          <span class="dropdown-title">Как я трекаю время</span>
          <span class="dropdown-icon">▼</span>
        </button>
        <div class="dropdown-content" id="tracking">
          <ul>
            <li>Лог времени веду в приложении <a href="https://atracker.pro/home.html" target="_blank" rel="noopener">atracker.pro</a></li>
            <li>Запускаю таймер только если уверен, что смогу полностью сфокусироваться на задаче</li>
            <li>Останавливаю таймер при любом отвлечении более 2 минут</li>
          </ul>
        </div>
      </div>

      <div class="dropdown">
        <button class="dropdown-toggle" data-target="exclusions">
          <span class="dropdown-title">Какие задачи не идут в счет</span>
          <span class="dropdown-icon">▼</span>
        </button>
        <div class="dropdown-content" id="exclusions">
          <ul>
            <li><strong>Повседневная рутина</strong> — поездки, быт, сон, готовка, уборка</li>
            <li><strong>Прокрастинация</strong> — бесцельное скроллинг соцсетей, просмотр развлекательного контента</li>
            <li><strong>Пассивное потребление</strong> — просмотр фильмов, сериалов без образовательной цели</li>
            <li><strong>Социальные активности</strong> — встречи с друзьями, праздники, неформальное общение</li>
          </ul>
        </div>
      </div>

      <div class="dropdown">
        <button class="dropdown-toggle" data-target="expectations">
          <span class="dropdown-title">Какие ожидания</span>
          <span class="dropdown-icon">▼</span>
        </button>
        <div class="dropdown-content" id="expectations">
          <p>С июня я веду лог времени: в среднем выходит 6–7 часов продуктивной деятельности в день, остальное уходит на второстепенные задачи. Значит, моя цель — лучше держать фокус на важном и уметь переключаться между сферами, чтобы не ловить выгорание.</p>
          <p>Исходя из опыта предыдущего 100-дневного челленджа, делаю предикт, что примерно на 60-й день наступит сильное выгорание. В этот период планирую взять отпуск, полностью отдохнув от стандартных задач и сосредоточившись на восстановлении — чтении художественной литературы, увеличении спортивных нагрузок в 3-4 раза и других релаксирующих активностях.</p>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ---- откуда подтягиваем данные ----
    const DATA_URL = 'progress.json'; // лежит рядом с index.html

    // ---- элементы ----
    const gridEl     = document.getElementById('grid');
    const percentEl  = document.getElementById('percent');
    const totalHours = document.getElementById('totalHours');
    const totalProgressFill = document.getElementById('totalProgressFill');
    const totalPercentage = document.getElementById('totalPercentage');
    const timeRemaining = document.getElementById('timeRemaining');
    const timeProgressFill = document.getElementById('timeProgressFill');
    const timePercentage = document.getElementById('timePercentage');
    const lastUpdated = document.getElementById('lastUpdated');
    
    // ---- элементы темы ----
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const themeText = document.getElementById('themeText');

    // ---- утилиты ----
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const fmt   = (n, d=1)=>Number(n).toFixed(d).replace(/\.0$/,'');
    const toISODate = (d)=>new Date(d).toISOString().slice(0,10);

    // ---- управление темами ----
    function isDayTime() {
      const hour = new Date().getHours();
      return hour >= 6 && hour < 18;
    }

    function getStoredTheme() {
      return localStorage.getItem('theme');
    }

    function setStoredTheme(theme) {
      localStorage.setItem('theme', theme);
    }

    function getCurrentTheme() {
      const stored = getStoredTheme();
      if (stored) {
        return stored;
      }
      return isDayTime() ? 'light' : 'dark';
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      updateThemeUI(theme);
    }

    function updateThemeUI(theme) {
      if (themeIcon && themeText) {
        if (theme === 'light') {
          themeIcon.textContent = '☀️';
          themeText.textContent = 'Светлая';
        } else {
          themeIcon.textContent = '🌙';
          themeText.textContent = 'Темная';
        }
      }
    }

    function toggleTheme() {
      const currentTheme = getCurrentTheme();
      const newTheme = currentTheme === 'light' ? 'dark' : 'light';
      setStoredTheme(newTheme);
      applyTheme(newTheme);
    }

    function initTheme() {
      const theme = getCurrentTheme();
      applyTheme(theme);
    }

    function checkTimeBasedTheme() {
      const stored = getStoredTheme();
      if (!stored) {
        // Если пользователь не выбрал тему вручную, переключаем по времени
        const theme = isDayTime() ? 'light' : 'dark';
        applyTheme(theme);
      }
    }

    // ---- основной рендер ----
    function render(data){
      const goal = Number(data.goal||1000);
      const start = data.startDate ? toISODate(data.startDate) : '—';
      const updated = data.updatedAt ? new Date(data.updatedAt) : null;

      // total часов всегда вычисляем из byDay
      let total = 0;
      if (data.byDay && typeof data.byDay === 'object') {
        total = Object.values(data.byDay).reduce((a,b)=>a+Number(b||0),0);
      }

      // метрики
      const startDate = data.startDate ? new Date(data.startDate) : null;
      const today = new Date();
      const dayIdx = startDate ? (Math.floor((today - startDate)/(1000*60*60*24)) + 1) : 0;
      const daysPassed = clamp(dayIdx, 0, 100);
      const remainDays = clamp(100 - daysPassed, 0, 100);
      const pct = clamp(total/goal*100, 0, 100);
      const avg = daysPassed>0 ? total/daysPassed : 0;
      const needPerDay = remainDays>0 ? (goal - total)/remainDays : 0;

      percentEl.textContent = '';

      // Обновляем информационные блоки
      updateInfoBlocks(total, goal, pct, remainDays, updated);

      // сетка 1000 (25 x 40)
      const totalCells = 1000;
      const full = Math.floor(total);
      const frac = clamp(total - full, 0, 0.9999); // дробная часть

      // (пере)создаём клетки, если нужно
      if (gridEl.children.length !== totalCells) {
        gridEl.innerHTML = '';
        for (let i=0;i<totalCells;i++){
          const div = document.createElement('div');
          div.className = 'cell';
          gridEl.appendChild(div);
        }
      }
      // заливаем
      const cells = Array.from(gridEl.children);
      cells.forEach((c,i)=>{
        c.classList.toggle('filled', i < full);
        c.classList.toggle('partial', false);
        c.style.setProperty('--part','0%');
      });
      if (full < totalCells && frac > 0) {
        const c = cells[full];
        if (c){
          c.classList.add('filled','partial');
          c.style.setProperty('--part', `${Math.round(frac*100)}%`);
        }
      }
    }

    // ---- обновление информационных блоков ----
    function updateInfoBlocks(total, goal, pct, remainDays, updated) {
      // Total Hours блок
      if (totalHours) {
        totalHours.innerHTML = `${fmt(total, 1)} <span class="small-text">hours</span>`;
      }
      if (totalProgressFill && totalPercentage) {
        totalProgressFill.style.width = `${pct}%`;
        totalPercentage.textContent = `${fmt(pct, 1)}%`;
      }

      // Time Remaining блок
      if (timeRemaining) {
        if (remainDays > 0) {
          const dayText = remainDays === 1 ? 'day' : 'days';
          timeRemaining.textContent = `${remainDays} ${dayText}`;
        } else {
          timeRemaining.textContent = 'Completed';
        }
      }
      
      // Прогресс-бар времени (показывает сколько дней прошло из 100)
      const timeProgress = remainDays > 0 ? ((100 - remainDays) / 100) * 100 : 100;
      if (timeProgressFill && timePercentage) {
        timeProgressFill.style.width = `${timeProgress}%`;
        timePercentage.textContent = `${fmt(timeProgress, 1)}%`;
      }

      // Last Updated блок
      if (lastUpdated) {
        if (updated) {
          const now = new Date();
          const diffTime = now - updated;
          const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
          
          if (diffDays === 0) {
            lastUpdated.textContent = 'Today';
          } else {
            lastUpdated.textContent = updated.toLocaleDateString('en-US', {
              month: 'short',
              day: 'numeric',
              year: 'numeric'
            });
          }
        } else {
          lastUpdated.textContent = '—';
        }
      }
    }


    // ---- загрузка JSON (с анти-кэшером) ----
    async function load(){
      try{
        const res = await fetch(`${DATA_URL}?t=${Date.now()}`, {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();
        render(data);
      }catch(e){
        console.error('Не удалось загрузить progress.json:', e);
        document.getElementById('percent').textContent = 'Ошибка загрузки данных';
      }
    }

    // ---- анимированные частицы ----
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      const particleCount = 50;
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 20 + 's';
        particle.style.animationDuration = (15 + Math.random() * 10) + 's';
        particlesContainer.appendChild(particle);
      }
    }

    // ---- управление выпадающими списками ----
    function initDropdowns() {
      const dropdownToggles = document.querySelectorAll('.dropdown-toggle');
      
      dropdownToggles.forEach(toggle => {
        toggle.addEventListener('click', () => {
          const dropdown = toggle.closest('.dropdown');
          const targetId = toggle.getAttribute('data-target');
          const content = document.getElementById(targetId);
          
          // Закрываем все остальные выпадающие списки
          document.querySelectorAll('.dropdown').forEach(dd => {
            if (dd !== dropdown) {
              dd.classList.remove('active');
            }
          });
          
          // Переключаем текущий
          dropdown.classList.toggle('active');
        });
      });
      
      // Закрываем при клике вне выпадающего списка
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown')) {
          document.querySelectorAll('.dropdown').forEach(dd => {
            dd.classList.remove('active');
          });
        }
      });
    }

    // ---- инициализация ----
    load();
    createParticles();
    initTheme();
    initDropdowns();
    
    // Обработчик клика по переключателю темы
    if (themeToggle) {
      themeToggle.addEventListener('click', toggleTheme);
    }
    
    // Проверяем тему по времени каждую минуту
    setInterval(checkTimeBasedTheme, 60*1000);
    
    // можно автообновлять раз в 5 минут (если нужно — оставь; если нет — удали строку ниже)
    setInterval(load, 5*60*1000);
  </script>
</body>
</html>
